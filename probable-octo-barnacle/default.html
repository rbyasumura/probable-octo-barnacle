<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <style>
        canvas {
            border: solid 1px #000000;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }
    </style>
</head>
<body>
    <div style="float: left;">
        <div id="canvasContainer"></div>
        <button onclick="play();">Play</button>
        <button onclick="stop();">Stop</button>
        <button onclick="reset();">Reset</button>
    </div>
    <div style="float:left; margin-left: 1em;">
        Current Population: <span id="current-population"></span><br />
        Food: <span id="food"></span>
    </div>
    <script src="gaussian.js"></script>
    <script>
        var MAX_SPEED = 1 / 4;
        var NUMBER_OF_ANIMALS = 1000;
        var NUMBER_OF_FOODS = 1000;
        var AGE_LIMIT = 10000;
        var INITIAL_ENERGY = 2000;
        var FOOD_ENERGY = 400;
        var MATURITY_AGE = 2500;
        var REPRODUCTION_RATE = 0.001;

        var canvas = document.createElement("canvas");
        canvas.width = 800;
        canvas.height = 600;
        document.getElementById("canvasContainer").appendChild(canvas);

        var context = canvas.getContext("2d");

        var lastTimestamp;
        var animals = []
        for (var i = 0; i < NUMBER_OF_ANIMALS; i++) {
            animals.push(new animal(
                Math.random() * canvas.width,
                Math.random() * canvas.height,
                "rgb(" + (Math.random() * 100) + "%, " + (Math.random() * 100) + "%, " + (Math.random() * 100) + "%)",
                getGaussian(MAX_SPEED, MAX_SPEED),
                Math.random() * 2 * Math.PI,
                1));
        }

        var foods = [];
        for (var i = 0; i < NUMBER_OF_FOODS; i++) {
            foods.push(new food(Math.random() * canvas.width, Math.random() * canvas.height));
        }

        var background = new Image();
        background.src = "galaxy_s5-wallpaper-800x600.jpg";
        var raf;

        function food(x, y) {
            this.x = x;
            this.y = y;

            this.draw = function (context) {
                context.save();
                context.fillStyle = "green";
                context.fillRect(this.x, this.y, 1, 1);
                context.restore();
            }
        }
        function animal(x, y, color, speed, direction, generation) {
            this.x = x;
            this.y = y;
            this.color = color;
            this.speed = speed;
            this.direction = direction;
            this.age = 0;
            this.ageLimit = AGE_LIMIT;
            this.energy = INITIAL_ENERGY;
            this.generation = generation;

            this.pulse = function () {
                this.age++;
                this.energy--;
                if (this.age > this.ageLimit
                    || this.energy <= 0) {
                    this.die();
                    return false;
                }

                this.move();
                var i = foods.findIndex(function (element, index, array) {
                    return Math.round(element.x) === Math.round(this.x)
                        && Math.round(element.y) === Math.round(this.y);
                }, this);
                if (i > -1) {
                    this.energy += FOOD_ENERGY;
                    foods.splice(i, 1);
                }

                if (this.age > MATURITY_AGE
                    && Math.random() < REPRODUCTION_RATE) {

                    this.reproduce();
                }

                return true;
            };
            this.reproduce = function () {
                animals.push(new animal(
                    this.x,
                    this.y,
                    this.color,
                    this.speed * getGaussian(1, this.speed),
                    Math.random() * 2 * Math.PI,
                    this.generation + 1));
            }
            this.die = function () {
            };
            this.move = function () {
                var _x = this.x + this.speed * Math.cos(this.direction);
                var _y = this.y + this.speed * Math.sin(this.direction);
                if (0 > _x || _x > canvas.width) {
                    this.direction = Math.PI - this.direction
                    _x = this.x + this.speed * Math.cos(this.direction);
                }
                if (0 > _y || _y > canvas.height) {
                    this.direction = -this.direction;
                    _y = this.y + this.speed * Math.sin(this.direction);
                }
                this.x = _x;
                this.y = _y;
            };
            this.draw = function (context) {
                context.save();
                context.beginPath();
                context.arc(this.x, this.y, 1, 0, 2 * Math.PI);
                context.fillStyle = this.color;
                context.fill();
                context.closePath();
                context.restore();
            };
        }

        function render(timestamp) {
            context.save();
            context.clearRect(0, 0, canvas.width, canvas.height);

            context.transform(transform.scale, 0, 0, transform.scale, transform.dx, transform.dy);

            for (var i = 0; i < animals.length; i++) {
                if (animals[i].pulse()) {
                    animals[i].draw(context);
                }
                else {
                    animals.splice(i, 1);
                    i--;
                }
            }

            /// Replenish food
            for (var i = 0; i < 1; i++) {
                if (Math.random() > 0.5) {
                    foods.push(new food(Math.random() * canvas.width, Math.random() * canvas.height));
                }
            }
            for (var i = 0; i < foods.length; i++) {
                foods[i].draw(context);
            }

            context.restore();

            lastTimestamp = timestamp;

            raf = window.requestAnimationFrame(render);
        }
        function stop() {
            window.cancelAnimationFrame(raf);
        }
        function play() {
            raf = window.requestAnimationFrame(render);
        }
        function calculateScale(delta) {
            scale.exponent += delta / 10;
            scale.exponent = Math.max(0, scale.exponent);
            scale.power = Math.pow(2, scale.exponent);
        }
        function reset() {
            scale.exponent = 0;
            scale.power = 1;
            scale.x = 0;
            scale.y = 0;
            pan.x = 0;
            pan.y = 0;
        }

        setInterval(function () {
            document.getElementById("current-population").innerHTML = animals.length;
            document.getElementById("food").innerHTML = foods.length;
        }, 1000);

        play();
    </script>
    <script src="camera.js"></script>
</body>
</html>
